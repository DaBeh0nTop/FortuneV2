<!DOCTYPE html>
<html lang="tl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Fortune Cookie</title>
<link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet" />
<style>
:root {
  --cookie-shadow:#e0ac69;
  --bg-start:#c19a6b; /* coffee/khaki gradient */
  --bg-end:#f5deb3;
  --badge-positive: #4caf50;
  --badge-neutral: #2196f3;
  --badge-warning: #ff9800;
  --badge-negative: #f44336;
  --fortune-gradient: linear-gradient(90deg, #ff6f61, #ffb347);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  font-family:'Comfortaa',cursive;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  background:linear-gradient(135deg,var(--bg-start),var(--bg-end));
  text-align:center;
  padding:20px;
  user-select:none;
  overflow-x:hidden;
  position:relative;
}
header{text-align:center;margin-bottom:20px;}
header h1{font-size:2em;color:#fff; text-shadow: 1px 1px 3px rgba(0,0,0,0.4);}
header p{font-size:1em;color:#eee;margin-top:5px;}

.container{
  display:flex; flex-direction:column; align-items:center; z-index:2; position:relative;
}
.cookie{
  width:200px; max-width:80vw; cursor:pointer; transition:transform 0.3s;
  filter:drop-shadow(5px 5px 5px var(--cookie-shadow));
  transform-origin:center bottom;
  z-index:3;
}
.cookie:hover{transform:scale(1.05);}
.cookie.snap-open{animation:snapOpen 0.6s forwards;}
@keyframes snapOpen{0%{transform:scale(1) rotate(0deg);} 40%{transform:scale(1.1) rotate(-15deg);} 70%{transform:scale(1.05) rotate(10deg);} 100%{transform:scale(1) rotate(0deg);}}
.shake{animation:shake 0.5s cubic-bezier(0.36,0.07,0.19,0.97) both;}
@keyframes shake{10%,90%{transform:translate3d(-1px,0,0);} 20%,80%{transform:translate3d(2px,0,0);} 30%,50%,70%{transform:translate3d(-4px,0,0);} 40%,60%{transform:translate3d(4px,0,0);}}

.fortune-card{
  position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(0.5);
  opacity:0; visibility:hidden;
  background:rgba(255 255 255 / 0.18); border-radius:20px;
  padding:25px 30px; max-width:400px; width:90%;
  text-align:center; backdrop-filter:blur(15px);
  transition: transform 0.5s ease-out, opacity 0.5s ease-out, border-color 0.3s ease;
  border:4px solid transparent; z-index:10;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  user-select:none;
}
.fortune-card.show{transform:translate(-50%,-50%) scale(1); opacity:1; visibility:visible;}
.category-badge{
  font-family:"Poppins",sans-serif;
  font-weight:700;
  color:white;
  padding:8px 20px;
  border-radius:50px;
  text-transform:uppercase;
  font-size:0.9em;
  margin-bottom:15px;
  display:inline-block;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  user-select:none;
}
.category-positive {background: var(--badge-positive);}
.category-neutral {background: var(--badge-neutral);}
.category-warning {background: var(--badge-warning);}
.category-negative {background: var(--badge-negative);}

.fortune-text{
  font-size:1.4em;
  line-height:1.5;
  margin-bottom:20px;
  color: transparent;
  background: var(--fortune-gradient);
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
  font-weight: 600;
  user-select:text;
  white-space: pre-wrap;
}

.close-btn{
  margin-top:10px;
  padding:8px 16px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
  background:#333;
  color:#fff;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  transition: background-color 0.3s ease;
  user-select:none;
}
.close-btn:hover{
  background:#555;
}

#animation-text{
  position: fixed; top:65%; left:50%;
  transform: translate(-50%,-50%);
  font-size:1.6em; font-weight:700; text-align:center; display:none; z-index:20;
  background:linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: wave 1s ease-in-out infinite;
  letter-spacing:2px;
}
@keyframes wave{
  0%,100%{transform: translate(-50%,-50%) translateY(0);}
  25%{transform: translate(-50%,-50%) translateY(-5px);}
  50%{transform: translate(-50%,-50%) translateY(3px);}
  75%{transform: translate(-50%,-50%) translateY(-3px);}
}

#side-gif{
  position:fixed; top:50%; right:20px;
  transform: translateY(-50%);
  width:100px; max-width:25vw;
  z-index:1;
  border-radius:10px;
  box-shadow:0 0 15px rgba(0,0,0,0.3);
}

@media(max-width:600px){
  header h1{font-size:1.5em;}
  .fortune-text{font-size:1.2em;}
  .cookie{width:150px;}
  #side-gif{width:70px; right:10px;}
}
</style>
</head>
<body>

<header>
  <h1>FORTUNE COOKIE</h1>
  <p>Made by Bisayang Dabeh</p>
</header>

<div class="container">
  <img src="https://i.postimg.cc/NfQMp3Gx/image-removebg-preview.png" alt="Fortune Cookie" class="cookie" draggable="false"/>
</div>

<img id="side-gif" src="https://media.tenor.com/wBdiOvp_JFIAAAAj/cat-cat-meme.gif" alt="Side GIF"/>

<div class="fortune-card" role="dialog" aria-modal="true" aria-hidden="true" tabindex="0">
  <div class="category-badge" id="category-badge"></div>
  <p class="fortune-text" id="fortune-text"></p>
  <button class="close-btn" id="close-btn">X Close</button>
</div>

<div id="animation-text"></div>

<!-- NOTE: audio attributes handled in JS for mobile autoplay policies -->
<audio id="bg-music" preload="none" playsinline></audio>

<script>
let fortunes = []; // will load from fortunes.json
let available = [];
let cooldown = false;

const cookie = document.querySelector(".cookie");
const fortuneCard = document.querySelector(".fortune-card");
const categoryBadge = document.getElementById("category-badge");
const fortuneText = document.getElementById("fortune-text");
const closeBtn = document.getElementById("close-btn");
const animationText = document.getElementById("animation-text");
const bgMusic = document.getElementById("bg-music");

/* ==================== AUDIO: MOBILE-SAFE STARTER ==================== */

// files are in /songs per your repo
const songs = [
  "songs/song1.mp3",
  "songs/song2.mp3",
  "songs/song3.mp3",
  "songs/song4.mp3",
  // add more if you upload (song5.mp3, etc.)
];

function shuffle(arr){
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

let songQueue = shuffle([...songs]);
function nextSongSrc(){
  if (songQueue.length === 0) songQueue = shuffle([...songs]);
  return songQueue.pop();
}

let started = false;

async function playRandomSong(){
  if (!bgMusic.src) bgMusic.src = nextSongSrc();
  bgMusic.loop = false;         // rotate through tracks
  bgMusic.muted = false;
  bgMusic.volume = 1.0;

  try {
    await bgMusic.play();
  } catch (err) {
    console.log("Playback blocked, will retry on next gesture:", err?.message || err);
    started = false;
  }
}

async function startMusicOnce(){
  if (started) return;
  started = true;
  bgMusic.src = nextSongSrc();
  await playRandomSong();

  // If still paused (blocked), allow another attempt on next gesture
  if (bgMusic.paused) {
    started = false;
    return;
  }
  removeStartListeners();
}

function addStartListeners(){
  window.addEventListener("click", startMusicOnce);
  window.addEventListener("keydown", startMusicOnce);
  window.addEventListener("touchstart", startMusicOnce, {passive:true});
}
function removeStartListeners(){
  window.removeEventListener("click", startMusicOnce);
  window.removeEventListener("keydown", startMusicOnce);
  window.removeEventListener("touchstart", startMusicOnce);
}

// ensure cookie tap also kicks off audio
cookie.addEventListener("click", startMusicOnce);

// when a song ends, move to a new random one
bgMusic.addEventListener("ended", () => {
  bgMusic.src = nextSongSrc();
  playRandomSong();
});

// arm the starters
addStartListeners();

/* ==================== FORTUNES + UI ==================== */

const categoryStyles = {
  positive: {class:"category-positive", emoji:"🌟"},
  neutral:  {class:"category-neutral",  emoji:"🔮"},
  warning:  {class:"category-warning",  emoji:"⚠️"},
  negative: {class:"category-negative", emoji:"💔"},
};

// Load fortunes.json (must be in same directory as this HTML)
fetch("fortunes.json")
  .then(res => res.json())
  .then(data => {
    fortunes = data;
    available = shuffle([...fortunes]);
  })
  .catch(err => console.error("Failed to load fortunes.json:", err));

function getFortune(){
  if (available.length === 0) available = shuffle([...fortunes]);
  return available.pop();
}

function displayFortune(fortune){
  const catKey = (fortune.category || "Neutral").toLowerCase();
  const style = categoryStyles[catKey] || categoryStyles.neutral;

  categoryBadge.textContent = `${style.emoji} ${String(fortune.category || "Neutral").toUpperCase()}`;
  categoryBadge.className = "category-badge " + style.class;
  fortuneText.textContent = fortune.text || "";
  fortuneCard.classList.add("show");
  fortuneCard.setAttribute("aria-hidden","false");
}

function showAnimation(callback){
  let countdown = Math.floor(Math.random()*6)+5; // 5–10s
  animationText.style.display = "block";
  const messages = ["Munching...","Digesting...","Eating...","Blessed...","Crunching...","Thinking...","Dreaming..."];
  const interval = setInterval(()=>{
    countdown--;
    animationText.textContent = messages[Math.floor(Math.random()*messages.length)] + " [" + countdown + "s]";
    if(countdown <= 0){
      clearInterval(interval);
      animationText.style.display = "none";
      callback();
    }
  },1000);
}

cookie.addEventListener("click",()=>{
  if (cooldown) return;
  cooldown = true;
  cookie.classList.add("shake","snap-open");
  setTimeout(()=>{
    cookie.classList.remove("shake","snap-open");
    displayFortune(getFortune());
  },600);
});

closeBtn.addEventListener("click",()=>{
  fortuneCard.classList.remove("show");
  fortuneCard.setAttribute("aria-hidden","true");
  showAnimation(()=>{ cooldown = false; });
});
</script>

</body>
</html>
